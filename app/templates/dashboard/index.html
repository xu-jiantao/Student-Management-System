{% extends "base.html" %}
{% block title %}仪表盘{% endblock %}
{% block content %}
  <div class="dashboard-cards">
    <div class="stat-card">
      <div class="stat-card__icon stat-card__icon--primary">👥</div>
      <div class="stat-card__info">
        <div class="stat-card__label">学生总数</div>
        <div class="stat-card__value">{{ student_count }}</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-card__icon stat-card__icon--green">🏫</div>
      <div class="stat-card__info">
        <div class="stat-card__label">班级数量</div>
        <div class="stat-card__value">{{ class_count }}</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-card__icon stat-card__icon--orange">🧑‍🏫</div>
      <div class="stat-card__info">
        <div class="stat-card__label">教师数量</div>
        <div class="stat-card__value">{{ teacher_count }}</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-card__icon stat-card__icon--blue">📚</div>
      <div class="stat-card__info">
        <div class="stat-card__label">课程数量</div>
        <div class="stat-card__value">{{ course_count }}</div>
      </div>
    </div>
  </div>

  <div class="dashboard-layout">
    <div class="dashboard-main">
      <div class="card quick-actions">
        <div class="card-header">快捷操作</div>
        <div class="quick-actions__body">
          {% if current_user.has_permission('students.manage') %}
            <a class="btn btn-outline-primary" href="{{ url_for('students.create_student') }}">新增学生</a>
            <a class="btn btn-outline-primary" href="{{ url_for('students.import_students') }}">批量导入学生</a>
          {% endif %}
          {% if current_user.has_permission('classes.manage') %}
            <a class="btn btn-outline-secondary" href="{{ url_for('classes.create_class') }}">创建班级</a>
          {% endif %}
          {% if current_user.has_permission('courses.manage') %}
            <a class="btn btn-outline-secondary" href="{{ url_for('courses.create_course') }}">创建课程</a>
          {% endif %}
          {% if current_user.has_permission('grades.manage') %}
            <a class="btn btn-outline-success" href="{{ url_for('grades.entry') }}">录入成绩</a>
          {% endif %}
          {% if current_user.has_permission('attendance.manage') %}
            <a class="btn btn-outline-info" href="{{ url_for('attendance.check_attendance') }}">记录考勤</a>
          {% endif %}
          {% if current_user.has_permission('announcements.manage') %}
            <a class="btn btn-outline-warning" href="{{ url_for('announcements.create_announcement') }}">发布公告</a>
          {% endif %}
        </div>
      </div>

      <div class="dashboard-grid">
        <section class="card">
          <div class="card-header">成绩分析</div>
          <div class="card-body">
            {% if grade_stats %}
              <div class="stat-list">
                {% for name, avg in grade_stats %}
                  {% set percent = (avg or 0) | round(1, 'floor') %}
                  <div class="stat-item">
                    <div>
                      <div class="label">{{ name }}</div>
                      <div class="text-muted small">平均分</div>
                    </div>
                    <div class="w-100" style="padding: 0 1rem;">
                      <div class="progress-bar">
                        <span style="width: {{ percent }}%; background: var(--primary);"></span>
                      </div>
                    </div>
                    <div class="value">{{ '%.1f'|format(avg or 0) }}</div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-muted">暂无成绩数据</div>
            {% endif %}
          </div>
        </section>

        <section class="card">
          <div class="card-header">考勤统计（近30天）</div>
          <div class="card-body">
            {% set total_attendance = attendance_stats | map(attribute=1) | sum %}
            {% if total_attendance %}
              <div class="stat-list">
                {% for status, count in attendance_stats %}
                  {% set percent = (count / total_attendance * 100) | round(1, 'floor') %}
                  <div class="stat-item">
                    <div class="label">{{ status }}</div>
                    <div class="w-100" style="padding: 0 1rem;">
                      <div class="progress-bar">
                        <span style="width: {{ percent }}%; background: {% if status == '出勤' %}var(--success){% elif status == '缺勤' %}var(--danger){% else %}var(--warning){% endif %};"></span>
                      </div>
                    </div>
                    <div class="value">{{ percent }}%</div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-muted">暂无考勤记录</div>
            {% endif %}
          </div>
        </section>
      </div>
    </div>

    <aside class="dashboard-side">
      <section class="card">
        <div class="card-header">个人待办</div>
        <div class="card-body">
          <form method="post" class="mb-3">
            <div class="input-group">
              <input type="text" class="form-control" name="content" placeholder="添加新的待办事项" required>
              <input type="date" class="form-control" name="due_date">
              <button class="btn btn-primary" type="submit">添加</button>
            </div>
          </form>
          {% if todos %}
            <ul class="list-group list-group-flush">
              {% for todo in todos %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>{{ todo.content }}</span>
                  {% if todo.due_date %}<span class="badge text-bg-secondary">{{ todo.due_date }}</span>{% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="todo-empty">暂无待办事项</div>
          {% endif %}
        </div>
      </section>

      <section class="card">
        <div class="card-header">最新公告</div>
        <div class="card-body">
          {% if announcements %}
            <ul class="list-group list-group-flush">
              {% for announcement in announcements %}
                <li class="list-group-item">
                  <div class="d-flex justify-content-between">
                    <a href="{{ url_for('announcements.announcement_detail', announcement_id=announcement.id) }}">{{ announcement.title }}</a>
                    <span class="text-muted small">{{ announcement.created_at.strftime('%Y-%m-%d') }}</span>
                  </div>
                  <div class="text-muted small">{{ announcement.content[:80] }}{% if announcement.content|length > 80 %}...{% endif %}</div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-muted">暂无公告</div>
          {% endif %}
        </div>
      </section>

      <section class="card">
        <div class="card-header">系统消息</div>
        <div class="card-body">
          {% if messages %}
            <ul class="list-group list-group-flush">
              {% for message in messages %}
                <li class="list-group-item">
                  <div class="fw-bold">{{ message.title }}</div>
                  <div class="text-muted small">{{ message.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                  <p class="mb-0 small">{{ message.body }}</p>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="message-empty">暂无新消息</div>
          {% endif %}
        </div>
      </section>
    </aside>
  </div>
{% endblock %}
